<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QuickClaw V3 Dashboard</title>
  <style>
    :root{--bg:#0e1116;--card:#161b22;--line:#2d333b;--text:#e6edf3;--muted:#97a0b6;--ok:#3fb950;--bad:#f85149;--blue:#58a6ff}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 Inter,system-ui,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .tabs{display:flex;gap:8px;overflow:auto;padding-bottom:6px}
    .tab{background:#101723;border:1px solid var(--line);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;white-space:nowrap}
    .tab.active{border-color:#3d5fa8;color:#dce8ff}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:10px}
    .stat{font-size:12px;color:var(--muted)} .big{font-size:18px;font-weight:700}
    button,input,select,textarea{background:#0f141c;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px}
    button{cursor:pointer} button:hover{filter:brightness(1.1)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    pre{background:#0a0f15;border:1px solid var(--line);border-radius:8px;padding:10px;max-height:280px;overflow:auto;white-space:pre-wrap}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .muted{color:var(--muted)}
    .pill{display:inline-block;padding:3px 8px;border:1px solid #344054;border-radius:999px;font-size:12px;margin:0 6px 6px 0}
    .hidden{display:none}
    @media (max-width:700px){.wrap{padding:10px}.card{padding:12px}.top h2{font-size:18px}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h2 style="margin:0">QuickClaw V3 Command Center</h2>
    <div class="row">
      <button onclick="refreshAll()">Refresh</button>
      <button onclick="copyRoot()">Copy Root</button>
      <button onclick="copyConfig()">Copy Config</button>
    </div>
  </div>

  <div class="tabs" id="tabs"></div>

  <section id="tab-overview" class="tabpane"></section>
  <section id="tab-profiles" class="tabpane hidden"></section>
  <section id="tab-integrations" class="tabpane hidden"></section>
  <section id="tab-logs" class="tabpane hidden"></section>
  <section id="tab-config" class="tabpane hidden"></section>
  <section id="tab-activity" class="tabpane hidden"></section>
</div>

<script>
let LAST={root:'',config:''};
const tabs=['overview','profiles','integrations','logs','config','activity'];
let currentTab='overview';
const fields=['openaiApiKey','anthropicApiKey','telegramBotToken','ftpHost','ftpUser','emailUser'];

async function j(u,o){const r=await fetch(u,o);return r.json();}
async function txt(u){const r=await fetch(u);return r.text();}
const esc=s=>String(s||'').replace(/[&<>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
function addonPill(name,val){const c=val==='missing'?'bad':'ok';return `<span class="pill ${c}">${name}: ${val}</span>`;}

function renderTabs(){
  const el=document.getElementById('tabs');
  el.innerHTML=tabs.map(t=>`<button class="tab ${t===currentTab?'active':''}" onclick="setTab('${t}')">${t[0].toUpperCase()+t.slice(1)}</button>`).join('');
}
function setTab(tab){currentTab=tab; renderTabs(); tabs.forEach(t=>document.getElementById('tab-'+t).classList.toggle('hidden',t!==tab));}

async function renderOverview(){
  const s=await j('/api/status'); LAST.root=s.root||''; LAST.config=s.configPath||'';
  document.getElementById('tab-overview').innerHTML=`
    <div class="card"><div class="grid">
      <div><div class="stat">Gateway</div><div class="big ${s.gateway.running?'ok':'bad'}">${s.gateway.running?'RUNNING':'STOPPED'}</div><div class="muted">WS 18789: ${s.gateway.ws18789?'YES':'NO'} | Port 5000: ${s.gateway.port5000?'YES':'NO'}</div></div>
      <div><div class="stat">Dashboard</div><div class="big ok">RUNNING</div><div class="muted">PID ${s.dashboard.pid||'-'} Port ${s.dashboard.port}</div></div>
      <div><div class="stat">Root</div><div class="muted">${esc(s.root)}</div></div>
      <div><div class="stat">Config</div><div class="muted">${s.configExists?'Found':'Missing'}<br>${esc(s.configPath||'')}</div></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button onclick="startGw()">Start Gateway</button>
      <button onclick="stopGw()">Stop Gateway</button>
      <button onclick="restartGw()">Restart Gateway</button>
    </div></div>
    <div class="card"><b>Add-on sections detected</b><div style="margin-top:8px">${addonPill('openai',s.addons.openai)}${addonPill('anthropic',s.addons.anthropic)}${addonPill('telegram',s.addons.telegram)}${addonPill('ftp',s.addons.ftp)}${addonPill('email',s.addons.email)}</div></div>
    <div class="card"><b>Gateway Status Details</b><pre>${esc(s.gateway.statusText||'(none)')}</pre></div>`;
}

async function renderProfiles(){
  const r=await j('/api/profiles'); const profiles=r.profiles||[];
  document.getElementById('tab-profiles').innerHTML=`
    <div class="card"><div class="row"><input id="newProfileName" placeholder="Profile name"><button onclick="createProfile()">Add Profile</button><select id="profilesSelect">${profiles.map(p=>`<option value="${p.id}" ${p.active?'selected':''}>${esc(p.name)}${p.active?' (active)':''}</option>`).join('')}</select><button onclick="activateSelectedProfile()">Set Active</button></div></div>
    <div class="card"><b>All Profiles</b><pre>${esc(profiles.map(p=>`${p.active?'*':'-'} ${p.name} [${p.id}]`).join('\n')||'(none)')}</pre></div>`;
}

async function renderIntegrations(){
  const s=await j('/api/settings');
  document.getElementById('tab-integrations').innerHTML=`
    <div class="card"><b>Integration Settings (local storage)</b><div class="grid" style="margin-top:10px">
      ${fields.map(f=>`<div><div class="stat">${f}</div><input id="${f}" value="${esc(s[f]||'')}" style="width:100%"></div>`).join('')}
    </div>
    <div class="row" style="margin-top:10px">
      <button onclick="saveSettings()">Save Settings</button>
      <button onclick="applySettingsToConfig()">Apply Settings To Config</button>
      <button onclick="window.location='/api/settings/export'">Export Settings</button>
    </div></div>
    <div class="card"><b>Import Settings JSON</b>
      <textarea id="importJson" rows="8" style="width:100%" placeholder='{"settings":{"openaiApiKey":"..."}}'></textarea>
      <div class="row" style="margin-top:8px"><button onclick="importSettings()">Import</button></div>
    </div>`;
}

async function renderLogs(){
  const gw50=await txt('/api/log/gateway?lines=50');
  const db50=await txt('/api/log/dashboard?lines=50');
  document.getElementById('tab-logs').innerHTML=`
    <div class="card"><b>Gateway Log</b><div class="row" style="margin:8px 0"><button onclick="loadLogInto('gwLog', '/api/log/gateway?lines=50')">50</button><button onclick="loadLogInto('gwLog', '/api/log/gateway?lines=200')">200</button></div><pre id="gwLog">${esc(gw50)}</pre></div>
    <div class="card"><b>Dashboard Log</b><div class="row" style="margin:8px 0"><button onclick="loadLogInto('dbLog', '/api/log/dashboard?lines=50')">50</button><button onclick="loadLogInto('dbLog', '/api/log/dashboard?lines=200')">200</button></div><pre id="dbLog">${esc(db50)}</pre></div>`;
}

async function renderConfig(){
  const c=await j('/api/config');
  document.getElementById('tab-config').innerHTML=`<div class="card"><b>Config File</b><div class="muted">${esc(c.path||'')}</div><pre>${esc(c.content||'(missing)')}</pre></div>`;
}

async function renderActivity(){
  const a=await j('/api/activity');
  document.getElementById('tab-activity').innerHTML=`<div class="card"><b>Recent Activity</b><pre>${esc((a.events||[]).map(e=>e.text||JSON.stringify(e)).join('\n')||'(none)')}</pre></div>`;
}

async function loadLogInto(id,url){document.getElementById(id).textContent=await txt(url);}
async function startGw(){await j('/api/gateway/start',{method:'POST'});setTimeout(refreshAll,800);} 
async function stopGw(){await j('/api/gateway/stop',{method:'POST'});setTimeout(refreshAll,800);} 
async function restartGw(){await j('/api/gateway/restart',{method:'POST'});setTimeout(refreshAll,1200);} 
async function createProfile(){const n=document.getElementById('newProfileName').value.trim(); if(!n)return; await j('/api/profiles',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n})}); await renderProfiles();}
async function activateSelectedProfile(){const id=document.getElementById('profilesSelect').value; await j('/api/profiles/activate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})}); await renderProfiles();}
async function saveSettings(){const payload={}; fields.forEach(f=>{const el=document.getElementById(f); payload[f]=el?el.value:''}); await j('/api/settings',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});} 
async function applySettingsToConfig(){await j('/api/settings/apply-config',{method:'POST'}); await renderConfig(); await renderOverview();}
async function importSettings(){try{const v=JSON.parse(document.getElementById('importJson').value||'{}'); await j('/api/settings/import',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(v)}); await renderIntegrations();}catch(e){alert('Invalid JSON');}}
async function copyRoot(){if(LAST.root)await navigator.clipboard.writeText(LAST.root);} 
async function copyConfig(){if(LAST.config)await navigator.clipboard.writeText(LAST.config);} 

async function refreshAll(){await renderOverview();await renderProfiles();await renderIntegrations();await renderLogs();await renderConfig();await renderActivity();}

renderTabs(); setTab('overview'); refreshAll();
</script>
</body>
</html>
