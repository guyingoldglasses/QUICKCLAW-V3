<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QuickClaw V3 Dashboard</title>
  <style>
    :root{--bg:#0e1116;--card:#161b22;--line:#2d333b;--text:#e6edf3;--muted:#97a0b6;--ok:#3fb950;--bad:#f85149}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 Inter,system-ui,sans-serif}
    .wrap{max-width:1150px;margin:0 auto;padding:14px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .tabs{display:flex;gap:8px;overflow:auto;padding-bottom:6px;margin-top:10px}
    .tab{background:#101723;border:1px solid var(--line);color:var(--text);padding:8px 11px;border-radius:10px;cursor:pointer;white-space:nowrap}
    .tab.active{border-color:#3d5fa8;color:#dce8ff}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    .stat{font-size:12px;color:var(--muted)} .big{font-size:18px;font-weight:700}
    button,input,select,textarea{background:#0f141c;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px}
    button{cursor:pointer} button:hover{filter:brightness(1.08)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    pre{background:#0a0f15;border:1px solid var(--line);border-radius:8px;padding:10px;max-height:280px;overflow:auto;white-space:pre-wrap}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .muted{color:var(--muted)} .pill{display:inline-block;padding:3px 8px;border:1px solid #344054;border-radius:999px;font-size:12px;margin:0 6px 6px 0}
    .hidden{display:none}
    .break{overflow-wrap:anywhere;word-break:break-word}
    select{max-width:100%}
    @media (max-width:700px){.wrap{padding:10px}.card{padding:12px}.top h2{font-size:18px}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h2 style="margin:0">QuickClaw V3 Command Center</h2>
    <div class="row">
      <button onclick="refreshAll()">Refresh</button>
      <button onclick="copyRoot()">Copy Root</button>
      <button onclick="copyConfig()">Copy Config</button>
    </div>
  </div>

  <div id="modeBanner"></div>
  <div id="toast" class="toast hidden"></div>
  <div class="tabs" id="tabs"></div>

  <section id="tab-overview" class="tabpane"></section>
  <section id="tab-profiles" class="tabpane hidden"></section>
  <section id="tab-integrations" class="tabpane hidden"></section>
  <section id="tab-skills" class="tabpane hidden"></section>
  <section id="tab-antfarm" class="tabpane hidden"></section>
  <section id="tab-memory" class="tabpane hidden"></section>
  <section id="tab-system" class="tabpane hidden"></section>
  <section id="tab-security" class="tabpane hidden"></section>
  <section id="tab-logs" class="tabpane hidden"></section>
  <section id="tab-config" class="tabpane hidden"></section>
  <section id="tab-activity" class="tabpane hidden"></section>
</div>

<script>
let LAST={root:'',config:''};
const tabs=['overview','profiles','integrations','skills','antfarm','memory','system','security','logs','config','activity'];
let currentTab='overview';
const fields=['openaiApiKey','openaiOAuthEnabled','anthropicApiKey','telegramBotToken','ftpHost','ftpUser','emailUser'];

const API_BASE = (location.protocol === 'http:' || location.protocol === 'https:') ? '' : 'http://localhost:3000';
function apiCandidates(u){
  const list=[];
  if(API_BASE) list.push(`${API_BASE}${u}`);
  if(location.origin && location.origin !== 'null') list.push(`${location.origin}${u}`);
  list.push(`http://localhost:3000${u}`);
  list.push(`http://localhost:3001${u}`);
  return [...new Set(list)];
}
async function fetchWithFallback(u,o){
  let lastErr=null;
  for(const url of apiCandidates(u)){
    try{ return await fetch(url,o); }
    catch(e){ lastErr=e; }
  }
  throw lastErr || new Error('API fetch failed');
}
async function j(u,o){const r=await fetchWithFallback(u,o);return r.json();}
async function txt(u){const r=await fetchWithFallback(u);return r.text();}
const esc=s=>String(s||'').replace(/[&<>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
function showToast(msg){const el=document.getElementById('toast'); el.textContent=msg; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),2400);}
function showBanner(){
  const el=document.getElementById('modeBanner');
  if(location.protocol==='file:') el.innerHTML='<div class="banner"><b>File mode detected.</b> Dashboard is using <code>http://localhost:3000/api</code> fallback. For best results, open the printed localhost URL from Launch.</div>';
  else el.innerHTML='';
}
function addonPill(name,val){const c=val==='missing'?'bad':'ok';return `<span class="pill ${c}">${name}: ${val}</span>`;}

function renderTabs(){
  document.getElementById('tabs').innerHTML=tabs.map(t=>`<button class="tab ${t===currentTab?'active':''}" onclick="setTab('${t}')">${t[0].toUpperCase()+t.slice(1)}</button>`).join('');
}
async function setTab(tab){
  currentTab=tab;
  renderTabs();
  tabs.forEach(t=>document.getElementById('tab-'+t).classList.toggle('hidden',t!==tab));
  await renderTab(tab);
}

async function renderTab(tab){
  const map={overview:renderOverview,profiles:renderProfiles,integrations:renderIntegrations,skills:renderSkills,antfarm:renderAntfarm,memory:renderMemory,system:renderSystem,security:renderSecurity,logs:renderLogs,config:renderConfig,activity:renderActivity};
  const fn=map[tab];
  if(!fn) return;
  try{ await fn(); }
  catch(err){
    const pane=document.getElementById('tab-'+tab);
    if(pane) pane.innerHTML=`<div class="card"><b>Render error in ${tab}</b><pre>${esc(err?.message||String(err))}</pre></div>`; showToast(`Render error in ${tab}`);
  }
}

async function renderOverview(){
  const s=await j('/api/status'); LAST.root=s.root||''; LAST.config=s.configPath||'';
  document.getElementById('tab-overview').innerHTML=`
    <div class="card"><div class="grid">
      <div><div class="stat">Gateway</div><div class="big ${s.gateway.running?'ok':'bad'}">${s.gateway.running?'RUNNING':'STOPPED'}</div><div class="muted">WS 18789: ${s.gateway.ws18789?'YES':'NO'} | Port 5000: ${s.gateway.port5000?'YES':'NO'}</div></div>
      <div><div class="stat">Dashboard</div><div class="big ok">RUNNING</div><div class="muted">PID ${s.dashboard.pid||'-'} Port ${s.dashboard.port}</div></div>
      <div><div class="stat">Root</div><div class="muted break">${esc(s.root)}</div></div>
      <div><div class="stat">Config</div><div class="muted break">${s.configExists?'Found':'Missing'}<br>${esc(s.configPath||'')}</div></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button onclick="startGw()">Start Gateway</button>
      <button onclick="stopGw()">Stop Gateway</button>
      <button onclick="restartGw()">Restart Gateway</button>
    </div></div>
    <div class="card"><b>Add-on sections detected</b><div style="margin-top:8px">${addonPill('openai',s.addons.openai)}${addonPill('anthropic',s.addons.anthropic)}${addonPill('telegram',s.addons.telegram)}${addonPill('ftp',s.addons.ftp)}${addonPill('email',s.addons.email)}</div></div>
    <div class="card"><b>Gateway Status Details</b><pre>${esc(s.gateway.statusText||'(none)')}</pre></div>`;
}

async function renderProfiles(){
  const r=await j('/api/profiles'); const profiles=r.profiles||[];
  const options=profiles.map(p=>`<option value="${p.id}" ${p.active?'selected':''}>${esc(p.name)}${p.active?' (active)':''}</option>`).join('');
  const list=profiles.map(p=>`${p.active?'*':'-'} ${p.name} [${p.id}] | created ${p.createdAt||'-'} | last used ${p.lastUsedAt||'-'}`).join('\n')||'(none)';
  document.getElementById('tab-profiles').innerHTML=`
    <div class="card"><div class="row"><input id="newProfileName" placeholder="Profile name"><input id="newProfileNotes" placeholder="notes (optional)"><button onclick="createProfile()">Add Profile</button></div></div>
    <div class="card"><div class="row"><select id="profilesSelect" onchange="loadProfileEditor()">${options}</select><button onclick="activateSelectedProfile()">Set Active</button><input id="renameProfileName" placeholder="new name"><button onclick="renameProfile()">Rename</button><button onclick="deleteProfile()">Delete</button></div></div>
    <div class="card"><b>Selected Profile Details</b>
      <div class="grid" style="margin-top:8px">
        <div><div class="stat">Notes</div><textarea id="profileNotes" rows="4" style="width:100%"></textarea></div>
        <div><div class="stat">Soul / Persona</div><textarea id="profileSoul" rows="4" style="width:100%"></textarea></div>
        <div><div class="stat">Memory File Path</div><input id="profileMemoryPath" style="width:100%" placeholder="/Volumes/.../QuickClaw/memory/2026-02-25.md"></div>
      </div>
      <div class="row" style="margin-top:8px"><button onclick="saveProfileDetails()">Save Profile Details</button></div>
    </div>
    <div class="card"><b>All Profiles</b><pre>${esc(list)}</pre></div>`;
  setTimeout(loadProfileEditor, 0);
}

async function renderIntegrations(){
  const s=await j('/api/settings');
  const oauthChecked=s.openaiOAuthEnabled?'checked':'';
  document.getElementById('tab-integrations').innerHTML=`
    <div class="card"><b>Integration Settings (local storage)</b><div class="grid" style="margin-top:10px">
      <div><div class="stat">OpenAI API Key</div><input id="openaiApiKey" value="${esc(s.openaiApiKey||'')}" style="width:100%"></div>
      <div><div class="stat">OpenAI OAuth Mode</div><label class="row"><input id="openaiOAuthEnabled" type="checkbox" ${oauthChecked}>Enable OAuth-style mode flag</label></div>
      <div><div class="stat">Anthropic API Key</div><input id="anthropicApiKey" value="${esc(s.anthropicApiKey||'')}" style="width:100%"></div>
      <div><div class="stat">Telegram Bot Token</div><input id="telegramBotToken" value="${esc(s.telegramBotToken||'')}" style="width:100%"></div>
      <div><div class="stat">FTP Host</div><input id="ftpHost" value="${esc(s.ftpHost||'')}" style="width:100%"></div>
      <div><div class="stat">FTP User</div><input id="ftpUser" value="${esc(s.ftpUser||'')}" style="width:100%"></div>
      <div><div class="stat">Email User</div><input id="emailUser" value="${esc(s.emailUser||'')}" style="width:100%"></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button onclick="saveSettings()">Save Settings</button>
      <button onclick="applySettingsToConfig()">Apply Settings To Config</button>
      <button onclick="exportSettings()">Export Settings</button>
    </div></div>
    <div class="card"><b>Import Settings JSON</b>
      <textarea id="importJson" rows="8" style="width:100%" placeholder='{"settings":{"openaiApiKey":"..."}}'></textarea>
      <div class="row" style="margin-top:8px"><button onclick="importSettings()">Import</button></div>
    </div>`;
}

async function renderSkills(){
  const r=await j('/api/skills'); const skills=r.skills||[];
  const rows=skills.map(s=>{
    const includes = Array.isArray(s.includes) ? s.includes.join(', ') : '';
    return `<div class="card">
      <div class="row"><b>${esc(s.name)}</b><span class="pill">risk: ${esc(s.risk||'n/a')}</span><span class="pill">installed: ${s.installed?'yes':'no'}</span><span class="pill">enabled: ${s.enabled?'yes':'no'}</span></div>
      <div class="muted" style="margin-top:6px">${esc(s.description||'No description yet.')}</div>
      ${includes ? `<div class="muted" style="margin-top:4px"><b>Includes:</b> ${esc(includes)}</div>` : ''}
      <div class="row" style="margin-top:8px"><button onclick="installSkill('${s.id}')">Install</button><button onclick="toggleSkill('${s.id}', ${!s.enabled})">${s.enabled?'Disable':'Enable'}</button></div>
    </div>`;
  }).join('');
  document.getElementById('tab-skills').innerHTML=`<div class="card"><b>Skills Manager</b><p class="muted">Local-mode skills toggles and install flags. Full runtime install hooks can be layered next.</p></div>${rows}`;
}

async function renderAntfarm(){
  const st=await j('/api/antfarm/status');
  const rs=await j('/api/antfarm/runs');
  const runs=(rs.runs||[]).slice(0,20).map(r=>`- ${r.createdAt||''} | ${r.status} | ${r.task}`).join(' | ')||'(no runs yet)';
  document.getElementById('tab-antfarm').innerHTML=`
    <div class="card"><b>Antfarm</b><div class="muted">installedHint: ${st.installedHint?'yes':'no'} | runs: ${st.runsCount||0}</div>
      <div class="row" style="margin-top:8px"><input id="antfarmTask" placeholder="Enter task" style="min-width:280px"><button onclick="runAntfarmTask()">Run Task</button></div>
    </div>
    <div class="card"><b>Recent Runs</b><pre>${esc(runs)}</pre></div>`;
}

async function renderMemory(){
  const r=await j('/api/memory/files');
  const opts=(r.files||[]).map(f=>`<option value="${esc(f)}">${esc(f)}</option>`).join('');
  document.getElementById('tab-memory').innerHTML=`
    <div class="card"><b>Memory Files</b><div class="row" style="margin-top:8px"><select id="memorySelect" style="min-width:380px">${opts}</select><button onclick="loadMemoryFile()">Load</button><button onclick="saveMemoryFile()">Save</button></div>
    <textarea id="memoryContent" rows="16" style="width:100%;margin-top:8px"></textarea></div>`;
}

async function renderSystem(){
  const b=await j('/api/system/browse');
  const items=(b.items||[]).slice(0,120).map(i=>`<option value="${esc(i.path)}">${i.type==='dir'?'[DIR] ':'[FILE] '}${esc(i.name)}</option>`).join('');
  document.getElementById('tab-system').innerHTML=`
    <div class="card"><b>System Browser (safe: QuickClaw root only)</b>
      <div class="row" style="margin-top:8px"><button onclick="reloadBrowse()">Reload</button><select id="browseSelect" style="min-width:300px">${items}</select><button onclick="readSelectedFile()">Read File</button></div>
      <pre id="filePreview">Select a file and click Read File.</pre>
    </div>`;
}

async function renderSecurity(){
  const a=await j('/api/security/audit');
  const upd=await j('/api/updates/cli');
  const findings=(a.findings||[]).map(f=>`- [${f.level}] ${f.message}`).join('\n');
  document.getElementById('tab-security').innerHTML=`
    <div class="card"><b>Security Audit</b><div class="big">Score: ${a.score}</div><pre>${esc(findings||'(none)')}</pre><div class="row"><button onclick="securityFix()">Attempt Auto Fix</button></div></div>
    <div class="card"><b>Updates</b><pre>${esc(JSON.stringify(upd,null,2))}</pre></div>`;
}

async function renderLogs(){
  const gw50=await txt('/api/log/gateway?lines=50');
  const db50=await txt('/api/log/dashboard?lines=50');
  document.getElementById('tab-logs').innerHTML=`
    <div class="card"><b>Gateway Log</b><div class="row" style="margin:8px 0"><button onclick="loadLogInto('gwLog', '/api/log/gateway?lines=50')">50</button><button onclick="loadLogInto('gwLog', '/api/log/gateway?lines=200')">200</button></div><pre id="gwLog">${esc(gw50)}</pre></div>
    <div class="card"><b>Dashboard Log</b><div class="row" style="margin:8px 0"><button onclick="loadLogInto('dbLog', '/api/log/dashboard?lines=50')">50</button><button onclick="loadLogInto('dbLog', '/api/log/dashboard?lines=200')">200</button></div><pre id="dbLog">${esc(db50)}</pre></div>`;
}

async function renderConfig(){
  const c=await j('/api/config');
  const b=await j('/api/config/backups');
  document.getElementById('tab-config').innerHTML=`
    <div class="card"><b>Config File</b><div class="muted">${esc(c.path||'')}</div><pre>${esc(c.content||'(missing)')}</pre></div>
    <div class="card"><b>Backups</b><div class="row"><select id="backupSelect">${(b.files||[]).map(f=>`<option value="${esc(f)}">${esc(f)}</option>`).join('')}</select><button onclick="restoreBackup()">Restore Selected Backup</button></div></div>`;
}

async function renderActivity(){
  const a=await j('/api/activity');
  document.getElementById('tab-activity').innerHTML=`<div class="card"><b>Recent Activity</b><pre>${esc((a.events||[]).map(e=>e.text||JSON.stringify(e)).join('\n')||'(none)')}</pre></div>`;
}

async function loadLogInto(id,url){document.getElementById(id).textContent=await txt(url);}
async function startGw(){await j('/api/gateway/start',{method:'POST'});setTimeout(refreshAll,900);} 
async function stopGw(){await j('/api/gateway/stop',{method:'POST'});setTimeout(refreshAll,900);} 
async function restartGw(){await j('/api/gateway/restart',{method:'POST'});setTimeout(refreshAll,1200);} 

function loadProfileEditor(){
  const sel=document.getElementById('profilesSelect');
  if(!sel) return;
  const id=sel.value;
  j('/api/profiles').then(r=>{
    const pp=(r.profiles||[]).find(x=>x.id===id);
    if(!pp) return;
    const n=document.getElementById('profileNotes'); if(n) n.value=pp.notes||'';
    const so=document.getElementById('profileSoul'); if(so) so.value=pp.soul||'';
    const mp=document.getElementById('profileMemoryPath'); if(mp) mp.value=pp.memoryPath||'';
  }).catch(()=>{});
}

async function saveProfileDetails(){
  const id=document.getElementById('profilesSelect')?.value; if(!id) return;
  const notes=document.getElementById('profileNotes')?.value||'';
  const soul=document.getElementById('profileSoul')?.value||'';
  const memoryPath=document.getElementById('profileMemoryPath')?.value||'';
  await j('/api/profiles/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,notes,soul,memoryPath})});
  showToast('Profile details saved');
  await renderProfiles();
}

async function createProfile(){const n=document.getElementById('newProfileName')?.value?.trim(); const notes=document.getElementById('newProfileNotes')?.value||''; if(!n)return; await j('/api/profiles',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,notes})}); await renderProfiles();}
async function activateSelectedProfile(){const id=document.getElementById('profilesSelect')?.value; if(!id)return; await j('/api/profiles/activate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})}); await renderProfiles();}
async function renameProfile(){const id=document.getElementById('profilesSelect')?.value; const name=document.getElementById('renameProfileName')?.value?.trim(); if(!id||!name)return; await j('/api/profiles/rename',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,name})}); await renderProfiles();}
async function deleteProfile(){const id=document.getElementById('profilesSelect')?.value; if(!id)return; if(!confirm('Delete selected profile?'))return; await j('/api/profiles/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})}); await renderProfiles();}

async function saveSettings(){const payload={}; payload.openaiApiKey=document.getElementById('openaiApiKey')?.value||''; payload.openaiOAuthEnabled=!!document.getElementById('openaiOAuthEnabled')?.checked; payload.anthropicApiKey=document.getElementById('anthropicApiKey')?.value||''; payload.telegramBotToken=document.getElementById('telegramBotToken')?.value||''; payload.ftpHost=document.getElementById('ftpHost')?.value||''; payload.ftpUser=document.getElementById('ftpUser')?.value||''; payload.emailUser=document.getElementById('emailUser')?.value||''; await j('/api/settings',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); showToast('Settings saved');} 
async function applySettingsToConfig(){const r=await j('/api/settings/apply-config',{method:'POST'}); await renderConfig(); await renderOverview(); showToast(r.backup?'Config applied + backup created':'Config applied');}
async function importSettings(){try{const v=JSON.parse(document.getElementById('importJson').value||'{}'); await j('/api/settings/import',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(v)}); await renderIntegrations(); showToast('Settings imported');}catch(e){alert('Invalid JSON');}}
function exportSettings(){ window.location = apiCandidates('/api/settings/export')[0]; }

async function installSkill(id){await j('/api/skills/install',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})}); await renderSkills();}
async function toggleSkill(id,enabled){await j('/api/skills/toggle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,enabled})}); await renderSkills();}

async function reloadBrowse(){await renderSystem();}
async function readSelectedFile(){const p=document.getElementById('browseSelect')?.value; if(!p)return; const r=await j('/api/system/readfile?path='+encodeURIComponent(p)); document.getElementById('filePreview').textContent=r.ok?(r.content||'(empty)'):('Error: '+r.error);}
async function restoreBackup(){const file=document.getElementById('backupSelect')?.value; if(!file)return; if(!confirm('Restore this backup?')) return; await j('/api/config/restore',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({file})}); await renderConfig(); showToast('Config restored');}
async function securityFix(){const r=await j('/api/security/fix',{method:'POST'}); alert(r.message||'done'); await renderSecurity();}

async function copyRoot(){if(LAST.root)await navigator.clipboard.writeText(LAST.root);} 
async function copyConfig(){if(LAST.config)await navigator.clipboard.writeText(LAST.config);} 

async function refreshAll(){
  for (const t of tabs){
    await renderTab(t);
  }
}

renderTabs(); setTab('overview');
</script>
</body>
</html>
